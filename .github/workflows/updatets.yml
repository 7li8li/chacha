name: Update TS List
on:
  push:
    paths:
      - 'configts.env'
      - 'preconfigts.env'
      - 'iptvts.m3u'
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Repository
        uses: actions/checkout@v2

      - name: Initialize Logs
        run: |
          rm -f debug.log error.log

      - name: Load Parameters
        run: |
          set -e
          if [ ! -f preconfigts.env ] || [ ! -f configts.env ]; then
            echo "Error: Required env files are missing!" > error.log
            exit 1
          fi
          source preconfigts.env
          source configts.env
          echo "OLD_PARAM1=${OLD_PARAM1:-EMPTY}" | tee -a debug.log
          echo "NEW_PARAM1=${NEW_PARAM1:-EMPTY}" | tee -a debug.log

      - name: Update IPTV List
        run: |
          set -e
          if [ -f iptvts.m3u ] && [ -s iptvts.m3u ]; then
            sed -i "s|$OLD_PARAM1|${NEW_PARAM1:-$OLD_PARAM1}|g" iptvts.m3u || echo "Error updating OLD_PARAM1" >> error.log
          else
            echo "iptvts.m3u is missing or empty! Update aborted." >> error.log
            exit 1
          fi

      - name: Update Previous Config File
        run: |
          echo "OLD_PARAM1=${NEW_PARAM1:-$OLD_PARAM1}" > preconfigts.env

      - name: Commit and Push Updates
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add iptvts.m3u preconfigts.env debug.log error.log
          git commit -m "Auto update: Parameters changed" || echo "No changes to commit."
          git push || echo "No changes pushed."